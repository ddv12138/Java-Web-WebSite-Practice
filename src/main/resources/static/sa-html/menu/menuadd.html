<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>添加菜单项</title>
		<link href="https://unpkg.com/element-ui/lib/theme-chalk/index.css" rel="stylesheet">
	</head>
	<body>
		<el-card class="box-card">
			<el-form :label-position="labelPosition" :model="resource" :rules="rules" class="demo-ruleForm" id="form"
			         label-width="100px"
			         ref="resource">
				<el-form-item label="菜单项父级名称" prop="pid" v-if="!isModify">
					<el-input :disabled="true" v-model="resource.pname"></el-input>
				</el-form-item>
				<el-form-item label="菜单项父级id" prop="pid" style="display: none;" v-if="!isModify">
					<el-input :disabled="true" v-model="resource.pid"></el-input>
				</el-form-item>
				<el-form-item label="菜单项id" prop="id" style="display: none;" v-if="isModify">
					<el-input :disabled="true" v-model="resource.id"></el-input>
				</el-form-item>
				<el-form-item label="菜单项名称" prop="name">
					<el-input v-model="resource.name"></el-input>
				</el-form-item>
				<el-form-item label="菜单项URL(填写相对路径)" prop="url">
					<el-input v-model="resource.url"></el-input>
				</el-form-item>
				<el-form-item>
					<el-button @click="submitForm('resource')" type="primary">提交</el-button>
					<el-button @click="resetForm('resource')">重置</el-button>
				</el-form-item>
			</el-form>
		</el-card>
	</body>
	<script src="https://unpkg.com/vue@2.6.10/dist/vue.js"></script>
	<script src="https://unpkg.com/element-ui/lib/index.js"></script>
	<script src="https://unpkg.com/jquery@3.4.1/dist/jquery.js"></script>
	<script src="https://cdn.bootcss.com/layer/3.0.1/layer.min.js"></script>
	<script type="text/javascript">
        window.setData = function (data, modify) {
            let formdata = {
                name: data.name,
                url: data.url,
                id: data.id
            };
            if (!data) return;
            if (!modify) {
                formdata = {
                    pid: data.id,
                    pname: data.name,
                };
            }
            let resource = new Vue({
                el: "#form",
                data: {
                    isModify: modify,
                    labelPosition: "top",
                    resource: formdata,
                    rules: {
                        name: [
                            {required: true, message: '请输入菜单项名称', trigger: 'blur'},
                            {min: 0, max: 10, message: '长度不超过 10 个字符', trigger: 'blur'}
                        ],
                        url: [
                            {required: false, message: '请输入菜单项URL(填写相对路径,如果留空则是普通菜单节点)', trigger: 'blur'}
                        ],
                        pid: [
                            {required: true, message: '出现错误请重试', trigger: 'submit'}
                        ],
                        pname: [
                            {required: true, message: '出现错误请重试', trigger: 'submit'}
                        ]
                    }
                },
                methods: {
                    submitForm(formName) {
                        this.$refs[formName].validate((valid) => {
                            if (valid) {
                                let data = JSON.stringify(this.$refs[formName].model);
                                if (!this.isModify) {
                                    //新增时
                                    $.post("/resource", this.$refs[formName].model, function (data, status, xhr) {
                                        if (data && data.state) {
                                            layer.alert('添加成功', {icon: 1}, function (index) {
                                                layer.close(index);
                                                let curr_index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                                                parent.layer.close(curr_index); //再执行关闭
                                                console.log(parent);
                                                parent.refreshTreeData();
                                            });
                                        }
                                    }, "json");
                                } else {
                                    //修改时
                                    $.ajax({
                                        url: '/resource',
                                        type: 'PUT',
                                        data: JSON.stringify(this.$refs[formName].model),
                                        success: function (data) {
                                            if (data && data.state) {
                                                layer.alert('更新成功', {icon: 1}, function (index) {
                                                    layer.close(index);
                                                    let curr_index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                                                    parent.layer.close(curr_index); //再执行关闭
                                                    parent.refreshTreeData();
                                                });
                                            }
                                        }
                                    });
                                }
                            } else {
                                alert('出现错误!');
                                return false;
                            }
                        });
                    },
                    resetForm(formName) {
                        this.$refs[formName].resetFields();
                    }
                }
            })
        }
	</script>
</html>